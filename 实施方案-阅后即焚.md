# 雪花密语 - 阅后即焚实施方案

## 🎯 核心功能

### 1. 自定义时间限制
- 30秒、60秒、5分钟、10分钟、30分钟
- 或自定义时间

### 2. 真正的阅后即焚
- 时间到期后，解密密钥永久删除
- 雪花图片无法再解密
- 不保存到画廊

### 3. 扫描解密
- 分享雪花图片
- 接收方扫描图片
- 解密显示文字

---

## 🏗️ 技术架构

### 后端选择：Vercel + Upstash Redis

**为什么选择这个方案？**
- ✅ Vercel Serverless Functions（免费）
- ✅ Upstash Redis（免费额度足够）
- ✅ 无需独立服务器
- ✅ 自动扩展
- ✅ 全球CDN

### API 设计

```typescript
// POST /api/snowflake/create
interface CreateRequest {
  text: string;        // 原始文字
  ttl: number;         // 生存时间（秒）
  essence: string;     // 精华类型
}

interface CreateResponse {
  id: string;          // 雪花ID
  qrCode: string;      // 二维码数据URL
  expiresAt: number;   // 过期时间戳
}

// GET /api/snowflake/decode/:id
interface DecodeResponse {
  text: string;        // 解密后的文字
  expiresIn: number;   // 剩余秒数
  essence: string;     // 精华类型
}

// 或返回错误
interface ErrorResponse {
  error: string;       // "expired" | "not_found"
  message: string;     // 错误信息
}
```

---

## 📝 实施步骤

### Phase 1: 后端搭建

#### 1.1 安装依赖
```bash
npm install @upstash/redis qrcode
npm install -D @types/qrcode
```

#### 1.2 配置 Upstash Redis
```typescript
// lib/redis.ts
import { Redis } from '@upstash/redis';

export const redis = new Redis({
  url: process.env.UPSTASH_REDIS_REST_URL!,
  token: process.env.UPSTASH_REDIS_REST_TOKEN!,
});
```

#### 1.3 创建 API - 编码
```typescript
// api/snowflake/create.ts
import { redis } from '../../lib/redis';
import { nanoid } from 'nanoid';
import QRCode from 'qrcode';

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const { text, ttl = 60, essence = 'aurora' } = req.body;

  // 生成唯一ID
  const id = nanoid(10);

  // 存储到Redis（带过期时间）
  await redis.setex(
    `snowflake:${id}`,
    ttl,
    JSON.stringify({
      text,
      essence,
      createdAt: Date.now(),
    })
  );

  // 生成二维码
  const qrCodeUrl = `${process.env.NEXT_PUBLIC_APP_URL}/decode/${id}`;
  const qrCode = await QRCode.toDataURL(qrCodeUrl);

  return res.status(200).json({
    id,
    qrCode,
    expiresAt: Date.now() + ttl * 1000,
  });
}
```

#### 1.4 创建 API - 解码
```typescript
// api/snowflake/decode/[id].ts
import { redis } from '../../../lib/redis';

export default async function handler(req, res) {
  const { id } = req.query;

  // 从Redis获取数据
  const data = await redis.get(`snowflake:${id}`);

  if (!data) {
    return res.status(404).json({
      error: 'expired',
      message: '雪花已融化，无法解密',
    });
  }

  const { text, essence, createdAt } = JSON.parse(data);

  // 获取剩余时间
  const ttl = await redis.ttl(`snowflake:${id}`);

  return res.status(200).json({
    text,
    essence,
    expiresIn: ttl,
  });
}
```

### Phase 2: 前端改造

#### 2.1 修改创建页面

```typescript
// components/EncryptView.tsx
const [ttl, setTtl] = useState(60); // 默认60秒

// 时间选择器
const timeOptions = [
  { label: '30秒', value: 30 },
  { label: '1分钟', value: 60 },
  { label: '5分钟', value: 300 },
  { label: '10分钟', value: 600 },
  { label: '30分钟', value: 1800 },
];

const handleCrystallize = async () => {
  // 调用后端API
  const response = await fetch('/api/snowflake/create', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      text: text.trim(),
      ttl: ttl,
      essence: essence,
    }),
  });

  const { id, qrCode, expiresAt } = await response.json();

  // 生成雪花图案
  const snowflake = generateSnowflakeDataURL(text, 800);

  // 合成图片（雪花 + 二维码）
  const finalImage = await combineSnowflakeWithQR(snowflake, qrCode);

  // 进入查看页面
  onCrystallized({
    id,
    text,
    image: finalImage,
    expiresAt,
  });
};
```

#### 2.2 新增扫描页面

```typescript
// components/ScanView.tsx
import { useState } from 'react';
import { QrReader } from 'react-qr-reader';

const ScanView = ({ onDecoded, onBack }) => {
  const [scanning, setScanning] = useState(false);

  const handleScan = async (result) => {
    if (!result) return;

    // 提取ID
    const url = new URL(result.text);
    const id = url.pathname.split('/').pop();

    // 调用解码API
    try {
      const response = await fetch(`/api/snowflake/decode/${id}`);
      
      if (response.status === 404) {
        alert('雪花已融化，无法解密');
        return;
      }

      const data = await response.json();
      onDecoded(data);
    } catch (error) {
      alert('解码失败');
    }
  };

  return (
    <div className="scan-view">
      <h1>扫描雪花</h1>
      
      {scanning ? (
        <QrReader
          onResult={handleScan}
          constraints={{ facingMode: 'environment' }}
        />
      ) : (
        <button onClick={() => setScanning(true)}>
          开始扫描
        </button>
      )}

      <button onClick={onBack}>返回</button>
    </div>
  );
};
```

#### 2.3 修改查看页面

```typescript
// components/DecryptView.tsx
const DecryptView = ({ id, text, image, expiresAt, onClose }) => {
  const [timeLeft, setTimeLeft] = useState(
    Math.floor((expiresAt - Date.now()) / 1000)
  );

  useEffect(() => {
    const timer = setInterval(() => {
      const remaining = Math.floor((expiresAt - Date.now()) / 1000);
      setTimeLeft(remaining);

      if (remaining <= 0) {
        setIsMelting(true);
        setTimeout(onClose, 2000);
      }
    }, 1000);

    return () => clearInterval(timer);
  }, [expiresAt]);

  return (
    <div>
      <h1>雪花密语</h1>
      
      {/* 雪花图片（包含二维码） */}
      <img src={image} alt="snowflake" />
      
      {/* 原始文字（仅创建者可见） */}
      <p>{text}</p>
      
      {/* 倒计时 */}
      <div className="countdown">
        <span>{timeLeft}</span> 秒
      </div>

      {/* 警告 */}
      <div className="warning">
        ⚠️ 阅后即焚
        时间到期后，雪花将永久无法解密
      </div>

      {/* 操作按钮 */}
      <button onClick={downloadImage}>下载图片</button>
      <button onClick={shareImage}>分享</button>
    </div>
  );
};
```

#### 2.4 新增解码成功页面

```typescript
// components/DecodedView.tsx
const DecodedView = ({ text, essence, expiresIn, onClose }) => {
  const [timeLeft, setTimeLeft] = useState(expiresIn);

  useEffect(() => {
    const timer = setInterval(() => {
      setTimeLeft(prev => {
        if (prev <= 1) {
          clearInterval(timer);
          setTimeout(onClose, 2000);
          return 0;
        }
        return prev - 1;
      });
    }, 1000);

    return () => clearInterval(timer);
  }, []);

  return (
    <div>
      <h1>✓ 解密成功</h1>
      
      {/* 雪花图案 */}
      <img src={generateSnowflakeDataURL(text, 600)} />
      
      {/* 解密后的文字 */}
      <div className="decoded-text">
        {text}
      </div>
      
      {/* 倒计时 */}
      <div className="countdown">
        还有 <span>{timeLeft}</span> 秒可以查看
      </div>

      {/* 警告 */}
      <div className="warning">
        ⚠️ 时间到期后将永久无法查看
      </div>

      <button onClick={screenshot}>截图保存</button>
    </div>
  );
};
```

### Phase 3: 图片合成

#### 3.1 合成雪花和二维码

```typescript
// utils/imageComposer.ts
export async function combineSnowflakeWithQR(
  snowflakeDataURL: string,
  qrCodeDataURL: string
): Promise<string> {
  return new Promise((resolve) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d')!;
    
    canvas.width = 1200;
    canvas.height = 1200;

    // 加载雪花图片
    const snowflakeImg = new Image();
    snowflakeImg.onload = () => {
      // 绘制雪花
      ctx.drawImage(snowflakeImg, 0, 0, 1200, 1200);

      // 加载二维码
      const qrImg = new Image();
      qrImg.onload = () => {
        // 在中心绘制半透明的二维码
        const qrSize = 200;
        const qrX = (1200 - qrSize) / 2;
        const qrY = (1200 - qrSize) / 2;

        // 绘制白色背景
        ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
        ctx.fillRect(qrX - 10, qrY - 10, qrSize + 20, qrSize + 20);

        // 绘制二维码
        ctx.drawImage(qrImg, qrX, qrY, qrSize, qrSize);

        // 返回合成图片
        resolve(canvas.toDataURL('image/png'));
      };
      qrImg.src = qrCodeDataURL;
    };
    snowflakeImg.src = snowflakeDataURL;
  });
}
```

---

## 🎨 UI 设计

### 创建页面

```
┌─────────────────────────────────────┐
│  雪花密语                           │
│                                     │
│  写下你的心语...                    │
│  ┌─────────────────────────────┐   │
│  │ 晚上8点，老地方见           │   │
│  └─────────────────────────────┘   │
│                                     │
│  选择精华：                         │
│  ● 极光之息  ○ 星尘之梦            │
│                                     │
│  ⏱️ 时间限制：                      │
│  ┌─────────────────────────────┐   │
│  │ ○ 30秒   ● 60秒   ○ 5分钟  │   │
│  │ ○ 10分钟  ○ 30分钟          │   │
│  └─────────────────────────────┘   │
│                                     │
│  💡 阅后即焚：                      │
│  时间到期后，雪花将永久无法解密     │
│  不会保存到画廊                     │
│                                     │
│  [凝结心语]                         │
└─────────────────────────────────────┘
```

### 查看页面（创建者）

```
┌─────────────────────────────────────┐
│  ✨ 雪花已生成                      │
│                                     │
│  ┌─────────────────────────────┐   │
│  │                             │   │
│  │    [雪花图案]               │   │
│  │                             │   │
│  │    [二维码在中心]           │   │
│  │                             │   │
│  └─────────────────────────────┘   │
│                                     │
│  你的心语：                         │
│  "晚上8点，老地方见"                │
│                                     │
│  ⏱️ 倒计时：45 秒                   │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                     │
│  [下载图片] [分享]                  │
│                                     │
│  ⚠️ 阅后即焚                        │
│  时间到期后，雪花将永久无法解密     │
│  不会保存到画廊                     │
└─────────────────────────────────────┘
```

### 首页（新增扫描入口）

```
┌─────────────────────────────────────┐
│  雪花密语                           │
│  Snowflake Whisper                  │
│                                     │
│  [大雪花动画]                       │
│                                     │
│  ┌─────────────────────────────┐   │
│  │  📝 凝结心语                │   │
│  │  创建一片独特的雪花          │   │
│  └─────────────────────────────┘   │
│                                     │
│  ┌─────────────────────────────┐   │
│  │  🔍 扫描雪花                │   │
│  │  解密隐藏的心语              │   │
│  └─────────────────────────────┘   │
│                                     │
│  ┌─────────────────────────────┐   │
│  │  🖼️ 心语画廊                │   │
│  │  查看历史记录（仅预设）      │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

---

## 📋 实施清单

### 后端
- [ ] 注册 Upstash Redis
- [ ] 配置环境变量
- [ ] 创建 /api/snowflake/create
- [ ] 创建 /api/snowflake/decode/[id]
- [ ] 测试 API

### 前端
- [ ] 安装依赖（qrcode, react-qr-reader）
- [ ] 修改 EncryptView（添加时间选择）
- [ ] 修改 DecryptView（显示倒计时）
- [ ] 新增 ScanView（扫描功能）
- [ ] 新增 DecodedView（解密成功）
- [ ] 实现图片合成功能
- [ ] 移除画廊保存逻辑

### 测试
- [ ] 创建雪花
- [ ] 下载图片
- [ ] 扫描解密
- [ ] 时间到期测试
- [ ] 再次扫描（应该失败）

---

## 🚀 部署

### 环境变量
```env
# .env.local
UPSTASH_REDIS_REST_URL=https://xxx.upstash.io
UPSTASH_REDIS_REST_TOKEN=xxx
NEXT_PUBLIC_APP_URL=https://snowflake-whisper.vercel.app
```

### Vercel 部署
```bash
# 1. 推送代码
git add .
git commit -m "feat: 实现阅后即焚功能"
git push origin main

# 2. Vercel 自动部署
# 3. 配置环境变量
```

---

**准备好开始实施了吗？我可以立即开始编写代码！** 🚀

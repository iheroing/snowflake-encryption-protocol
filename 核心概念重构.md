# 雪花密语 - 核心概念重构

## 💡 顿悟时刻

### 真正的产品逻辑

**雪花本身就是加密后的信息！**

```
文字 → 编码到雪花图案 → 分享雪花图片 → 扫描雪花 → 解码成文字
                                              ↓
                                         时间限制
                                         (60秒后失效)
```

这不是简单的"文字+雪花"，而是**文字被编码在雪花的结构里**！

---

## 🎯 重新定义产品

### 核心概念：雪花即密码

**就像自然界的雪花**：
- 每片雪花都是独一无二的
- 雪花的结构包含了信息
- 雪花会融化（时间限制）
- 融化后信息永久消失

**我们的雪花密语**：
- 文字被编码在雪花的图案里
- 雪花图案本身就是加密信息
- 分享雪花图片 = 分享加密信息
- 扫描雪花 = 解密信息
- 60秒后，解密密钥失效

---

## 🔐 加密原理

### 方案 A：雪花图案编码（推荐）

**编码方式**：
```
文字 → Hash → 雪花参数 → 生成雪花图案
                ↓
            时间戳 + 密钥
                ↓
        存储在服务器/区块链
                ↓
            60秒后删除
```

**解码方式**：
```
雪花图片 → 提取参数 → 查询服务器 → 获取密钥 → 解密文字
                                    ↓
                                60秒后
                                    ↓
                                密钥失效
                                    ↓
                            无法解密（永久）
```

### 方案 B：隐写术（Steganography）

**编码方式**：
```
文字 → 加密 → 嵌入雪花图片的像素中 → 生成图片
        ↓
    时间戳 + 密钥
        ↓
    存储在服务器
        ↓
    60秒后删除
```

**解码方式**：
```
雪花图片 → 提取隐藏数据 → 查询服务器 → 获取密钥 → 解密文字
                                        ↓
                                    60秒后
                                        ↓
                                    密钥失效
```

### 方案 C：二维码混合（最简单）

**编码方式**：
```
文字 → 加密 → 生成唯一ID → 存储在服务器
                ↓
            生成二维码
                ↓
        嵌入雪花图案中
                ↓
            60秒后删除
```

**解码方式**：
```
雪花图片 → 扫描二维码 → 获取ID → 查询服务器 → 解密文字
                                            ↓
                                        60秒后
                                            ↓
                                        数据已删除
```

---

## 🎨 完整的用户流程

### 发送方（创建者）

```
1. 输入心语
   "晚上8点，老地方见"

2. 选择精华类型
   极光之息 / 星尘之梦

3. 点击"凝结心语"
   ├─ 文字被编码到雪花图案
   ├─ 生成唯一的雪花图片
   ├─ 加密密钥存储在服务器
   └─ 开始60秒倒计时

4. 查看雪花
   ├─ 看到美丽的雪花图案
   ├─ 看到原始文字（创建者可见）
   └─ 倒计时：60秒

5. 分享雪花
   ├─ 下载雪花图片
   ├─ 发送给朋友
   └─ 或生成分享链接

6. 60秒后
   ├─ 雪花"融化"（视觉效果）
   ├─ 服务器删除解密密钥
   └─ 雪花图片变成永久的谜
```

### 接收方（扫描者）

```
1. 收到雪花图片
   朋友发来一张美丽的雪花图片

2. 打开雪花密语应用
   点击"扫描雪花"

3. 扫描/上传图片
   ├─ 使用相机扫描
   └─ 或上传图片

4. 解密过程
   ├─ 提取雪花中的编码信息
   ├─ 查询服务器获取密钥
   └─ 解密显示文字

5. 查看心语
   ├─ 显示解密后的文字
   ├─ 显示剩余时间
   └─ "还有 30 秒可以查看"

6. 时间到期
   ├─ 再次扫描
   ├─ 服务器返回：密钥已失效
   └─ 显示：雪花已融化
```

---

## 🏗️ 技术架构

### 前端（当前）
```
React App
├─ 创建页面：编码文字到雪花
├─ 查看页面：显示雪花 + 文字
├─ 扫描页面：解码雪花图片
└─ 画廊页面：历史记录
```

### 后端（需要新增）
```
API Server
├─ POST /api/encode
│   ├─ 接收：文字 + 时间限制
│   ├─ 生成：唯一ID + 加密密钥
│   ├─ 存储：Redis (60秒过期)
│   └─ 返回：ID + 雪花参数

├─ GET /api/decode/:id
│   ├─ 接收：雪花ID
│   ├─ 查询：Redis
│   ├─ 检查：是否过期
│   └─ 返回：解密密钥 或 已过期

└─ 定时任务
    └─ 清理过期数据
```

### 数据存储
```
Redis (临时存储)
├─ Key: snowflake:{id}
├─ Value: {
│   text: "加密后的文字",
│   key: "解密密钥",
│   createdAt: timestamp
│ }
└─ TTL: 60秒
```

---

## 🎯 核心功能实现

### 1. 编码（创建雪花）

```typescript
// 前端
async function createSnowflake(text: string) {
  // 1. 调用后端API
  const response = await fetch('/api/encode', {
    method: 'POST',
    body: JSON.stringify({
      text: text,
      ttl: 60 // 60秒
    })
  });
  
  const { id, snowflakeParams } = await response.json();
  
  // 2. 生成雪花图案（基于参数）
  const snowflake = generateSnowflake(snowflakeParams);
  
  // 3. 将ID嵌入雪花图片
  const imageWithId = embedIdInImage(snowflake, id);
  
  // 4. 返回图片
  return imageWithId;
}
```

### 2. 解码（扫描雪花）

```typescript
// 前端
async function scanSnowflake(imageFile: File) {
  // 1. 从图片中提取ID
  const id = extractIdFromImage(imageFile);
  
  // 2. 调用后端API解密
  const response = await fetch(`/api/decode/${id}`);
  
  if (response.status === 404) {
    return { error: '雪花已融化，无法解密' };
  }
  
  const { text, expiresIn } = await response.json();
  
  // 3. 返回解密后的文字
  return {
    text: text,
    expiresIn: expiresIn // 剩余秒数
  };
}
```

### 3. ID嵌入方式

#### 方案 A：二维码（最简单）
```typescript
function embedIdInImage(snowflake: SVG, id: string) {
  // 1. 生成二维码
  const qrCode = generateQRCode(id);
  
  // 2. 将二维码嵌入雪花中心
  const combined = combineImages(snowflake, qrCode, {
    position: 'center',
    size: 'small',
    opacity: 0.3 // 半透明
  });
  
  return combined;
}
```

#### 方案 B：隐写术（更隐蔽）
```typescript
function embedIdInImage(snowflake: Canvas, id: string) {
  // 1. 将ID转换为二进制
  const binary = textToBinary(id);
  
  // 2. 嵌入到像素的最低位
  const pixels = snowflake.getImageData();
  for (let i = 0; i < binary.length; i++) {
    pixels.data[i * 4] = (pixels.data[i * 4] & 0xFE) | binary[i];
  }
  
  snowflake.putImageData(pixels);
  return snowflake;
}
```

---

## 🎨 UI/UX 设计

### 创建页面

```
┌─────────────────────────────────────┐
│  雪花密语                           │
│                                     │
│  写下你的心语...                    │
│  ┌─────────────────────────────┐   │
│  │ 晚上8点，老地方见           │   │
│  └─────────────────────────────┘   │
│                                     │
│  选择精华：                         │
│  ○ 极光之息  ● 星尘之梦            │
│                                     │
│  ⏱️ 时间限制：                      │
│  ○ 30秒  ● 60秒  ○ 5分钟          │
│                                     │
│  💡 提示：                          │
│  文字将被编码到雪花图案中           │
│  时间到期后，雪花将永久无法解密     │
│                                     │
│  [凝结心语]                         │
└─────────────────────────────────────┘
```

### 查看页面（创建者）

```
┌─────────────────────────────────────┐
│  ✨ 雪花已生成                      │
│                                     │
│  [美丽的雪花图案]                   │
│  (包含隐藏的二维码)                 │
│                                     │
│  你的心语：                         │
│  "晚上8点，老地方见"                │
│                                     │
│  ⏱️ 倒计时：45 秒                   │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                     │
│  💡 快速分享：                      │
│  [下载图片] [复制链接] [分享]      │
│                                     │
│  ⚠️ 60秒后，雪花将永久无法解密      │
└─────────────────────────────────────┘
```

### 扫描页面（接收者）

```
┌─────────────────────────────────────┐
│  🔍 扫描雪花                        │
│                                     │
│  ┌─────────────────────────────┐   │
│  │                             │   │
│  │    [相机取景框]             │   │
│  │                             │   │
│  │  对准雪花图片进行扫描       │   │
│  │                             │   │
│  └─────────────────────────────┘   │
│                                     │
│  或                                 │
│                                     │
│  [上传图片]                         │
│                                     │
│  💡 提示：                          │
│  扫描雪花图片，解密隐藏的心语       │
└─────────────────────────────────────┘
```

### 解密成功页面

```
┌─────────────────────────────────────┐
│  ✓ 解密成功                         │
│                                     │
│  [雪花图案]                         │
│                                     │
│  心语内容：                         │
│  ┌─────────────────────────────┐   │
│  │ 晚上8点，老地方见           │   │
│  └─────────────────────────────┘   │
│                                     │
│  ⏱️ 还有 30 秒可以查看              │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                     │
│  [截图保存]                         │
│                                     │
│  ⚠️ 时间到期后将永久无法查看        │
└─────────────────────────────────────┘
```

### 解密失败页面

```
┌─────────────────────────────────────┐
│  ❄️ 雪花已融化                      │
│                                     │
│  [融化的雪花动画]                   │
│                                     │
│  这片雪花已经融化                   │
│  隐藏的心语永远消失了               │
│                                     │
│  💭 "世上没有两片相同的雪花         │
│      也没有两次相同的机会"          │
│                                     │
│  [返回首页]                         │
└─────────────────────────────────────┘
```

---

## 🔄 完整流程图

```
创建者                          系统                          接收者
  │                              │                              │
  ├─ 输入文字 ──────────────────>│                              │
  │                              │                              │
  │                              ├─ 生成ID                      │
  │                              ├─ 加密文字                    │
  │                              ├─ 存储到Redis (60秒TTL)       │
  │                              ├─ 生成雪花图案                │
  │                              └─ 嵌入ID到图片                │
  │                              │                              │
  │<─ 返回雪花图片 ──────────────┤                              │
  │                              │                              │
  ├─ 查看雪花 + 文字              │                              │
  ├─ 下载/分享图片 ──────────────────────────────────────────>│
  │                              │                              │
  │                              │                              ├─ 收到图片
  │                              │                              ├─ 打开应用
  │                              │                              ├─ 扫描雪花
  │                              │                              │
  │                              │<─ 提取ID ────────────────────┤
  │                              │                              │
  │                              ├─ 查询Redis                   │
  │                              ├─ 检查是否过期                │
  │                              ├─ 解密文字                    │
  │                              │                              │
  │                              ├─ 返回文字 ──────────────────>│
  │                              │                              │
  │                              │                              ├─ 显示心语
  │                              │                              └─ 显示倒计时
  │                              │                              │
  ├─ 60秒后                       │                              │
  │                              │                              │
  │                              ├─ Redis自动删除数据            │
  │                              │                              │
  │                              │                              ├─ 再次扫描
  │                              │<─────────────────────────────┤
  │                              │                              │
  │                              ├─ 查询Redis                   │
  │                              ├─ 数据不存在                  │
  │                              │                              │
  │                              ├─ 返回：已过期 ───────────────>│
  │                              │                              │
  │                              │                              └─ 显示：雪花已融化
```

---

## 💾 数据结构

### Redis 存储
```typescript
interface SnowflakeData {
  id: string;              // 唯一ID
  encryptedText: string;   // 加密后的文字
  key: string;             // 解密密钥
  createdAt: number;       // 创建时间戳
  expiresAt: number;       // 过期时间戳
  ttl: number;             // 生存时间（秒）
}

// Redis Key
const key = `snowflake:${id}`;

// Redis Value
const value = JSON.stringify({
  encryptedText: "...",
  key: "...",
  createdAt: Date.now(),
  expiresAt: Date.now() + 60000,
  ttl: 60
});

// Redis TTL
redis.setex(key, 60, value);
```

---

## 🎯 MVP 实现计划

### Phase 1：基础功能（1-2天）
1. ✅ 后端API搭建
   - POST /api/encode
   - GET /api/decode/:id
   - Redis 集成

2. ✅ 前端集成
   - 创建时调用encode API
   - 生成雪花图片（嵌入二维码）
   - 扫描功能（读取二维码）

3. ✅ 基础UI
   - 创建页面
   - 扫描页面
   - 解密成功/失败页面

### Phase 2：体验优化（2-3天）
1. ⭐ 视觉效果
   - 雪花生成动画
   - 融化动画
   - 倒计时动画

2. ⭐ 交互优化
   - 相机扫描
   - 图片上传
   - 分享功能

3. ⭐ 错误处理
   - 网络错误
   - 扫描失败
   - 已过期提示

### Phase 3：高级功能（3-5天）
1. 💡 隐写术
   - 替代二维码
   - 更隐蔽的编码

2. 💡 多种时间限制
   - 30秒、60秒、5分钟
   - 自定义时间

3. 💡 分享链接
   - 生成短链接
   - 直接打开解密

---

## 🤔 需要决定的问题

### 1. ID嵌入方式
- **方案A**：二维码（简单，但明显）
- **方案B**：隐写术（隐蔽，但复杂）
- **方案C**：混合（二维码+隐写术）

### 2. 后端部署
- **方案A**：Vercel Serverless Functions
- **方案B**：独立服务器 + Redis
- **方案C**：Supabase + Edge Functions

### 3. 数据存储
- **方案A**：Redis（需要服务器）
- **方案B**：Supabase（托管服务）
- **方案C**：区块链（去中心化，但复杂）

---

**这才是真正的"雪花加密协议"！你觉得这个方向对吗？** 🎯
